name: Anticlaw CI

on:
  push:
    branches: ["main", "develop", "release/**"]
  pull_request:
    branches: ["main", "develop"]
  workflow_dispatch:
    inputs:
      run_full_scan:
        description: "Run full deep scan suite"
        required: false
        default: "false"
        type: boolean

env:
  PYTHON_VERSION: "3.11"
  ANTICLAW_PORT: ${{ vars.ANTICLAW_PORT || '8765' }}
  ANTICLAW_BIND: ${{ vars.ANTICLAW_BIND || '127.0.0.1' }}

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # PRE-DEPLOYMENT: lint + type-check + unit tests
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pre-deploy:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]" || pip install -r requirements-dev.txt || true
          pip install pytest pytest-asyncio pytest-cov ruff mypy

      - name: Lint (ruff)
        run: ruff check anticlaw/ --output-format=github

      - name: Type-check (mypy)
        run: mypy anticlaw/ --ignore-missing-imports || true

      - name: Extract version
        id: version
        run: |
          VERSION=$(python -c "import tomllib; f=open('pyproject.toml','rb'); d=tomllib.load(f); print(d['project']['version'])" 2>/dev/null || echo "0.0.0-dev")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "ðŸ“¦ Version: $VERSION"

      - name: Unit tests
        run: |
          pytest tests/ -v \
            --cov=anticlaw \
            --cov-report=term-missing \
            --cov-report=json:reports/coverage.json \
            --cov-report=html:reports/coverage_html \
            --tb=short \
            -q \
            2>&1 | tee reports/pytest_output.txt || true

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pre-deploy-reports
          path: reports/
          retention-days: 14

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # SCAN: run anticlaw's own self-scan
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  self-scan:
    name: Anticlaw Self-Scan
    runs-on: ubuntu-latest
    needs: pre-deploy

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install anticlaw
        run: pip install -e . || true

      - name: Run scan & generate reports
        run: |
          mkdir -p reports
          python -m anticlaw.ci_runner \
            --output-json reports/scan_report.json \
            --output-html reports/scan_report.html \
            --port ${{ env.ANTICLAW_PORT }} \
            --bind ${{ env.ANTICLAW_BIND }} \
            || python scripts/generate_reports.py

      - name: Upload scan reports
        uses: actions/upload-artifact@v4
        with:
          name: scan-reports
          path: reports/
          retention-days: 30

      - name: Post scan summary
        run: |
          if [ -f reports/scan_report.json ]; then
            python -c "
          import json, sys
          with open('reports/scan_report.json') as f:
              r = json.load(f)
          detected = r.get('detected', False)
          severity = r.get('severity','none')
          total    = r.get('summary', {}).get('total', 0)
          print(f'### Anticlaw Scan Summary')
          print(f'- Detected: {detected}')
          print(f'- Severity: {severity}')
          print(f'- Total findings: {total}')
          if severity in ('critical','high'):
              print('::error::Anticlaw detected HIGH/CRITICAL severity issues!')
              sys.exit(1)
          elif detected:
              print('::warning::Anticlaw detected low-severity findings.')
          "
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # BUILD: package
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: [pre-deploy, self-scan]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build wheel + sdist
        run: |
          pip install build
          python -m build
          ls -lh dist/

      - name: Upload dist
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 30

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # POST-DEPLOYMENT: smoke test + health check
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  post-deploy:
    name: Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Download dist
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Install built package
        run: pip install dist/*.whl

      - name: Smoke test â€” import check
        run: |
          python -c "
          from anticlaw.scanner import scan
          from anticlaw.core.channel import score
          from anticlaw.core.acp import scan_acp_message
          from anticlaw.extended.pairing_bypass import detect
          from anticlaw.extended.canvas import detect as canvas_detect
          from anticlaw.extended.tool_sequence import detect as seq_detect
          from anticlaw.extended.correlator import detect_coordinated
          print('âœ… All anticlaw modules imported successfully')
          "

      - name: Smoke test â€” live scan
        run: |
          python -c "
          from anticlaw.scanner import scan
          result = scan(
              text='Hello from CI smoke test',
              agent_id='ci-runner',
              channel='webhook',
          )
          print('Scan result:', result['severity'], '| detected:', result['detected'])
          assert 'severity' in result
          assert 'openclaw_layers' in result
          print('âœ… Smoke scan passed')
          "

      - name: Post-deployment report
        run: |
          mkdir -p reports
          python -c "
          import json, datetime
          report = {
              'stage': 'post_deployment',
              'timestamp': datetime.datetime.utcnow().isoformat() + 'Z',
              'version': '${{ needs.pre-deploy.outputs.version }}',
              'port': '${{ env.ANTICLAW_PORT }}',
              'bind': '${{ env.ANTICLAW_BIND }}',
              'smoke_tests': 'passed',
              'status': 'healthy',
          }
          with open('reports/post_deploy.json', 'w') as f:
              json.dump(report, f, indent=2)
          print(json.dumps(report, indent=2))
          "

      - name: Upload post-deploy report
        uses: actions/upload-artifact@v4
        with:
          name: post-deploy-report
          path: reports/post_deploy.json
          retention-days: 30